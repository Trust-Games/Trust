<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trust Games | Direct Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { background: #050505; color: #e4e4e7; font-family: sans-serif; overflow: hidden; height: 100dvh; }
        #app-shell { display: none; height: 100dvh; width: 100vw; position: relative; }

        /* Sidebar Overlay Logic */
        .sidebar { 
            width: 280px; background: #09090b; border-right: 1px solid #18181b; 
            display: flex; flex-direction: column; height: 100%;
            position: absolute; left: 0; top: 0; z-index: 5000;
            transition: transform 0.3s ease; transform: translateX(-100%);
        }
        .sidebar.active { transform: translateX(0); box-shadow: 20px 0 60px #000; }
        
        @media (min-width: 1024px) {
            .sidebar { transform: translateX(0); position: relative; }
            main { flex: 1; }
            #menu-trigger { display: none; }
        }

        main { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        #main-content { flex: 1; overflow-y: auto; padding: 1.5rem; -webkit-overflow-scrolling: touch; }

        /* Admin UI Fix */
        .admin-box { background: #0f0f12; border: 1px solid #1c1c21; padding: 1rem; border-radius: 1rem; margin-bottom: 0.5rem; }
        .btn-verify { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 8px; font-size: 10px; font-weight: 900; }
        .btn-unverify { border: 1px solid #27272a; color: #71717a; padding: 8px 16px; border-radius: 8px; font-size: 10px; }

        /* Chat Scaling Fix */
        .chat-wrap { display: flex; flex-direction: column; height: 100%; background: #09090b; border-radius: 1rem; border: 1px solid #18181b; overflow: hidden; }
        .msg-bubble { padding: 10px 14px; border-radius: 1rem; max-width: 80%; font-size: 13px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-black z-[9999] flex items-center justify-center font-black text-blue-500">REPAIRING CONNECTIONS...</div>

    <button id="menu-trigger" onclick="toggleSide()" class="fixed top-4 left-4 z-[4500] bg-zinc-900 p-3 rounded-xl">â˜°</button>

    <div id="app-shell" class="flex">
        <aside id="sidebar" class="sidebar">
            <div class="p-8 text-2xl font-black italic">TRUST</div>
            <nav class="flex-1 px-2 space-y-1">
                <button onclick="nav('home')" class="w-full text-left p-4 font-bold text-xs uppercase hover:bg-zinc-900 rounded-xl">Vault</button>
                <button onclick="nav('social')" class="w-full text-left p-4 font-bold text-xs uppercase hover:bg-zinc-900 rounded-xl">Messages</button>
                <button onclick="nav('friends')" class="w-full text-left p-4 font-bold text-xs uppercase hover:bg-zinc-900 rounded-xl">Circle</button>
                <button id="adm-nav" onclick="nav('admin')" class="hidden w-full text-left p-4 font-bold text-xs uppercase text-yellow-500">Staff Room</button>
            </nav>
            <div class="p-6 border-t border-zinc-900">
                <p id="u-display" class="font-bold text-sm text-white"></p>
                <button onclick="auth.signOut()" class="text-[9px] text-zinc-600 uppercase mt-2">Sign Out</button>
            </div>
        </aside>

        <main>
            <header class="h-[70px] border-b border-zinc-900 flex items-center px-6 justify-end">
                <input id="search" oninput="runSearch()" placeholder="Search ID..." class="bg-zinc-900 p-3 rounded-xl text-xs w-48 outline-none border border-transparent focus:border-blue-600">
            </header>
            <div id="main-content"></div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/90 z-[6000] hidden items-center justify-center p-4" onclick="this.style.display='none'">
        <div class="bg-[#0c0c0e] w-full max-w-sm rounded-[2rem] p-8 border border-zinc-800" onclick="event.stopPropagation()">
            <div id="modal-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, orderBy, addDoc, serverTimestamp, limit, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDV1Iq9F7N152JjXN7goayLLBiES8B4HkU", authDomain: "trust-games-1.firebaseapp.com", projectId: "trust-games-1", storageBucket: "trust-games-1.firebasestorage.app", messagingSenderId: "923318206410", appId: "1:923318206410:web:646cfe42238f9136cb5933" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null, activeChatID = null;

        onAuthStateChanged(auth, u => {
            if (u) {
                const id = u.email.split('@')[0].toLowerCase();
                onSnapshot(doc(db, "users", id), snap => {
                    me = snap.data();
                    document.getElementById('u-display').innerHTML = `${me.username}${me.is_verified ? ' âœ…' : ''}`;
                    if(['owner','admin'].includes(me.role)) document.getElementById('adm-nav').classList.remove('hidden');
                    document.getElementById('app-shell').style.display = 'flex';
                    document.getElementById('loader').style.display = 'none';
                    if(!document.getElementById('main-content').innerHTML) nav('home');
                });
            } else { location.reload(); }
        });

        window.toggleSide = () => document.getElementById('sidebar').classList.toggle('active');
        window.nav = t => { showTab(t); if(window.innerWidth < 1024) toggleSide(); };

        window.showTab = async (t) => {
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="p-10 text-center animate-pulse text-xs">LOADING...</div>`;

            if(t === 'admin') {
                const snap = await getDocs(collection(db, "users"));
                main.innerHTML = `<h2 class="text-xl font-black mb-6 uppercase">User Database</h2>`;
                snap.forEach(d => {
                    const u = d.data();
                    main.innerHTML += `
                        <div class="admin-box flex justify-between items-center">
                            <span class="text-xs font-bold uppercase">${u.username}</span>
                            <button onclick="toggleVerify('${d.id}', ${u.is_verified})" class="${u.is_verified ? 'btn-verify' : 'btn-unverify'}">
                                ${u.is_verified ? 'VERIFIED' : 'VERIFY'}
                            </button>
                        </div>`;
                });
            }

            if(t === 'social') {
                main.innerHTML = `
                <div class="chat-wrap">
                    <div id="c-list" class="p-4 border-b border-zinc-900 flex gap-2 overflow-x-auto"></div>
                    <div id="c-win" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-3"></div>
                    <div class="p-4 bg-black flex gap-2">
                        <input id="msg-inp" class="flex-1 bg-zinc-900 p-3 rounded-xl text-xs outline-none" placeholder="Message...">
                        <button onclick="sendMsg()" class="bg-blue-600 px-6 rounded-xl font-black text-[10px] uppercase">Send</button>
                    </div>
                </div>`;
                onSnapshot(query(collection(db, "chats"), where("members", "array-contains", me.username.toLowerCase())), s => {
                    const list = document.getElementById('c-list'); if(!list) return; list.innerHTML = "";
                    s.forEach(d => {
                        const other = d.data().members.find(m => m !== me.username.toLowerCase());
                        list.innerHTML += `<button onclick="loadChat('${d.id}')" class="bg-zinc-800 px-4 py-2 rounded-lg text-[10px] font-black uppercase">${other}</button>`;
                    });
                });
            }

            if(t === 'home') {
                main.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="g-grid"></div>`;
                const s = await getDocs(collection(db, "games"));
                s.forEach(d => {
                    main.querySelector('#g-grid').innerHTML += `<div onclick="window.open('${d.data().url}')" class="bg-zinc-900 aspect-square rounded-3xl flex flex-col items-center justify-center border border-zinc-800 hover:border-blue-600 transition p-4">
                        <div class="text-3xl mb-2">ðŸŽ®</div><p class="text-[10px] font-black uppercase text-zinc-400">${d.data().name}</p>
                    </div>`;
                });
            }
        };

        window.toggleVerify = async (id, current) => {
            await updateDoc(doc(db, "users", id.toLowerCase()), { is_verified: !current });
            showTab('admin'); // Refresh list
        };

        window.loadChat = (id) => {
            activeChatID = id;
            onSnapshot(query(collection(db, "chats", id, "messages"), orderBy("time", "asc")), s => {
                const win = document.getElementById('c-win'); if(!win) return;
                win.innerHTML = "";
                s.forEach(d => {
                    const m = d.data(); const isMe = m.sender === me.username.toLowerCase();
                    win.innerHTML += `<div class="msg-bubble ${isMe ? 'bg-blue-600 self-end' : 'bg-zinc-800 self-start'}">${m.text}</div>`;
                });
                win.scrollTop = win.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const inp = document.getElementById('msg-inp');
            if(!inp.value || !activeChatID) return;
            await addDoc(collection(db, "chats", activeChatID, "messages"), {
                text: inp.value,
                sender: me.username.toLowerCase(),
                time: serverTimestamp()
            });
            inp.value = "";
        };

        window.runSearch = async () => {
            const v = document.getElementById('search').value.toLowerCase();
            if(!v) return;
            const s = await getDocs(query(collection(db, "users"), where("username", ">=", v), where("username", "<=", v + "\uf8ff"), limit(5)));
            const main = document.getElementById('main-content');
            main.innerHTML = `<h2 class="text-xs font-black mb-4 uppercase">Search Results</h2>`;
            s.forEach(d => {
                main.innerHTML += `<div onclick="openUser('${d.id}')" class="admin-box cursor-pointer hover:border-blue-500">${d.data().username}</div>`;
            });
        };

        window.openUser = async (id) => {
            const s = await getDoc(doc(db, "users", id.toLowerCase()));
            const u = s.data();
            const isF = me.following?.includes(id.toLowerCase());
            document.getElementById('modal-content').innerHTML = `
                <div class="text-center">
                    <p class="text-5xl font-black text-yellow-500 mb-2">${u.credits}</p>
                    <h3 class="text-xl font-black uppercase text-white">${u.username}${u.is_verified ? ' âœ…' : ''}</h3>
                </div>
                <div class="mt-8 flex flex-col gap-2">
                    <button onclick="startChat('${id}')" class="bg-white text-black py-4 rounded-xl font-black uppercase text-xs">Message</button>
                    <button onclick="follow('${id}', ${isF})" class="bg-zinc-800 py-4 rounded-xl font-black uppercase text-xs">${isF ? 'Unfollow' : 'Follow'}</button>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
        };

        window.startChat = async (id) => {
            const pair = [me.username.toLowerCase(), id.toLowerCase()].sort();
            const cid = pair.join('_');
            const chatRef = doc(db, "chats", cid);
            if(!(await getDoc(chatRef)).exists()) {
                await setDoc(chatRef, { members: pair, created: serverTimestamp() });
            }
            document.getElementById('modal').style.display = 'none';
            nav('social');
            setTimeout(() => loadChat(cid), 500);
        };

        window.follow = async (id, isF) => {
            await updateDoc(doc(db, "users", me.username.toLowerCase()), {
                following: isF ? arrayRemove(id.toLowerCase()) : arrayUnion(id.toLowerCase())
            });
            openUser(id);
        };
    </script>
</body>
</html>
