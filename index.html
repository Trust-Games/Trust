<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trust Games | Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #e4e4e7; font-family: 'Inter', sans-serif; overflow: hidden; }
        #app-shell { display: none; height: 100vh; width: 100vw; overflow: hidden; }
        #sidebar { width: 260px; background: #09090b; border-right: 1px solid #18181b; display: flex; flex-direction: column; flex-shrink: 0; }
        
        .badge-owner { color: #facc15; border: 1px solid #facc15; padding: 2px 6px; border-radius: 4px; font-size: 9px; text-transform: uppercase; background: rgba(250, 204, 21, 0.1); font-weight: 900; }
        .badge-admin { color: #3b82f6; border: 1px solid #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 9px; text-transform: uppercase; background: rgba(59, 130, 246, 0.1); font-weight: 900; }
        
        .card-gradient { background: linear-gradient(145deg, #111113 0%, #09090b 100%); border: 1px solid #1c1c21; }
        .follow-btn { transition: all 0.2s; border: 1px solid rgba(59, 130, 246, 0.5); }
        .follow-btn.following { background: #3b82f6; color: white; }

        #loader { background: #050505; position: fixed; inset: 0; z-index: 200; display: flex; align-items: center; justify-content: center; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loader"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-blue-500"></div></div>
    <div id="notification-container" class="fixed bottom-5 right-5 z-[999] flex flex-col-reverse gap-2 pointer-events-none"></div>

    <div id="app-shell" class="flex h-screen w-screen overflow-hidden">
        <aside id="sidebar">
            <div class="p-6 text-xl font-bold italic text-white tracking-tighter">TRUST</div>
            <nav class="flex-1 px-4 space-y-1 overflow-y-auto custom-scroll">
                <button onclick="showTab('home')" class="w-full p-4 flex items-center text-zinc-400 font-semibold hover:bg-zinc-900 rounded-xl transition">
                    <span>üéÆ</span><span class="ml-4">Vault</span>
                </button>
                <button onclick="showTab('messages')" class="w-full p-4 flex items-center text-zinc-400 font-semibold hover:bg-zinc-900 rounded-xl transition">
                    <span>üì©</span><span class="ml-4">Inbox</span>
                </button>
                <div id="admin-nav" class="hidden border-t border-zinc-800 mt-4 pt-4">
                    <button onclick="showTab('admin')" class="w-full p-4 flex items-center text-yellow-500 font-bold hover:bg-zinc-900 rounded-xl transition">
                        <span>üõ†</span><span class="ml-4">Admin</span>
                    </button>
                </div>
            </nav>
            <div class="p-4 flex-shrink-0 border-t border-zinc-800 bg-zinc-950/50">
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                    <div class="flex items-center gap-2 mb-1">
                        <p id="user-display" class="text-xs font-bold text-white truncate"></p>
                        <div id="role-icon-slot"></div>
                    </div>
                    <p id="user-credits" class="text-sm text-yellow-500 font-mono font-bold tracking-tighter">0 Credits</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#080808] min-w-0">
            <header class="p-6 border-b border-zinc-900 flex gap-4 items-center">
                <div class="relative flex-1 max-w-xl">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500">üîç</span>
                    <input id="global-search" oninput="handleSearch()" type="text" placeholder="Search games or players..." class="w-full bg-zinc-900/50 border border-zinc-800 p-3 pl-12 rounded-2xl text-sm outline-none focus:border-blue-500 transition">
                </div>
            </header>

            <div id="content" class="flex-1 overflow-y-auto p-6 md:p-10 custom-scroll">
                </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, updateDoc, arrayUnion, arrayRemove, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (Same as yours)
        const firebaseConfig = { apiKey: "AIzaSyDV1Iq9F7N152JjXN7goayLLBiES8B4HkU", authDomain: "trust-games-1.firebaseapp.com", projectId: "trust-games-1", storageBucket: "trust-games-1.firebasestorage.app", messagingSenderId: "923318206410", appId: "1:923318206410:web:646cfe42238f9136cb5933" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userProfile = null;
        let allGames = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const username = user.email.split('@')[0];
                onSnapshot(doc(db, "users", username), (snap) => {
                    userProfile = snap.data();
                    document.getElementById('user-display').innerText = userProfile.username;
                    document.getElementById('user-credits').innerText = `${(userProfile.credits || 0).toLocaleString()} Credits`;
                    if(userProfile.role === 'owner' || userProfile.role === 'admin') document.getElementById('admin-nav').classList.remove('hidden');
                    document.getElementById('app-shell').style.display = 'flex';
                    document.getElementById('loader').style.display = 'none';
                    showTab('home');
                });
            }
        });

        window.showTab = async (t) => {
            const main = document.getElementById('content');
            if (t === 'home') {
                main.innerHTML = `
                    <div id="player-results" class="mb-10 hidden">
                        <h3 class="text-xs font-bold text-zinc-500 uppercase mb-4 tracking-widest">Players Found</h3>
                        <div id="player-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                    <h3 class="text-xs font-bold text-zinc-500 uppercase mb-4 tracking-widest">Game Vault</h3>
                    <div id="game-list" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
                `;
                const snap = await getDocs(collection(db, "games"));
                allGames = [];
                snap.forEach(d => {
                    const g = d.data();
                    allGames.push(g);
                    renderGame(g);
                });
            }
            // ... (Other tabs follow previous logic)
        };

        function renderGame(g) {
            document.getElementById('game-list').innerHTML += `
                <div class="card-gradient rounded-[2rem] overflow-hidden group">
                    <div class="relative pt-[56.25%]">
                        <iframe src="${g.url}" class="absolute inset-0 w-full h-full border-0"></iframe>
                    </div>
                    <div class="p-5 flex justify-between items-center">
                        <span class="font-bold text-lg">${g.name}</span>
                        <button class="text-zinc-500 hover:text-white">‚≠ê</button>
                    </div>
                </div>`;
        }

        window.handleSearch = async () => {
            const queryStr = document.getElementById('global-search').value.toLowerCase();
            const playerSection = document.getElementById('player-results');
            const playerList = document.getElementById('player-list');
            const gameList = document.getElementById('game-list');

            if (queryStr.length < 1) {
                playerSection.classList.add('hidden');
                showTab('home');
                return;
            }

            // Search Games
            gameList.innerHTML = "";
            allGames.filter(g => g.name.toLowerCase().includes(queryStr)).forEach(renderGame);

            // Search Players (Direct fetch for demo, ideally indexed)
            const q = query(collection(db, "users"), where("username", ">=", queryStr), where("username", "<=", queryStr + '\uf8ff'), limit(5));
            const uSnap = await getDocs(q);
            
            playerList.innerHTML = "";
            if (!uSnap.empty) {
                playerSection.classList.remove('hidden');
                uSnap.forEach(doc => {
                    const u = doc.data();
                    if(u.username === userProfile.username) return;
                    const isFollowing = userProfile.following?.includes(u.username);
                    playerList.innerHTML += `
                        <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 flex items-center justify-between">
                            <div>
                                <p class="font-bold text-sm">${u.username}</p>
                                <span class="text-[9px] text-zinc-500 uppercase">${u.role || 'Player'}</span>
                            </div>
                            <button onclick="toggleFollow('${u.username}', ${isFollowing})" class="follow-btn ${isFollowing ? 'following' : ''} px-4 py-1.5 rounded-lg text-xs font-bold">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                        </div>`;
                });
            } else {
                playerSection.classList.add('hidden');
            }
        };

        window.toggleFollow = async (targetUser, currentlyFollowing) => {
            const myRef = doc(db, "users", userProfile.username);
            const targetRef = doc(db, "users", targetUser);

            if (currentlyFollowing) {
                await updateDoc(myRef, { following: arrayRemove(targetUser) });
                await updateDoc(targetRef, { followers: arrayRemove(userProfile.username) });
            } else {
                await updateDoc(myRef, { following: arrayUnion(targetUser) });
                await updateDoc(targetRef, { followers: arrayUnion(userProfile.username) });
            }
            handleSearch(); // Refresh UI
        };

    </script>
</body>
</html>
