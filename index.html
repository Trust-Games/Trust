<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trust Games | Hardened</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sidebar-w: 260px; }
        body { background-color: #050505; color: #e4e4e7; font-family: sans-serif; overflow: hidden; height: 100vh; }
        
        #app-shell { display: none; height: 100vh; width: 100vw; }
        
        .sidebar { 
            width: var(--sidebar-w); background: #09090b; border-right: 1px solid #18181b; 
            display: flex; flex-direction: column; transition: transform 0.3s ease;
            position: fixed; inset-y: 0; left: 0; z-index: 5000;
        }
        
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            main { margin-left: 0 !important; width: 100% !important; }
        }

        @media (min-width: 1025px) {
            main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); }
        }

        .content-area { height: calc(100vh - 80px); overflow-y: auto; padding: 1.5rem; }
        .tab-btn { width: 100%; padding: 14px 20px; text-align: left; color: #a1a1aa; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .tab-btn.active { color: #3b82f6; background: #111113; border-right: 4px solid #3b82f6; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center; p: 4; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-black z-[9999] flex items-center justify-center font-black text-blue-500">BOOTING SECURE ENGINE...</div>

    <button onclick="toggleSidebar()" class="lg:hidden fixed top-5 left-5 z-[4000] bg-zinc-900 p-3 rounded-xl border border-zinc-800">
        <svg width="20" height="20" fill="white" viewBox="0 0 20 20"><path d="M3 5h14M3 10h14M3 15h14" stroke="white" stroke-width="2"/></svg>
    </button>

    <div id="profile-modal" class="modal" onclick="this.style.display='none'">
        <div class="bg-[#0c0c0e] p-8 rounded-[2rem] w-full max-w-sm border border-zinc-800" onclick="event.stopPropagation()">
            <div id="modal-inner"></div>
        </div>
    </div>

    <div id="app-shell">
        <aside id="main-sidebar" class="sidebar">
            <div class="p-8 text-2xl font-black italic text-white">TRUST</div>
            <nav class="flex-1">
                <button onclick="navTo('home')" id="btn-home" class="tab-btn active">Vault</button>
                <button onclick="navTo('social')" id="btn-social" class="tab-btn">Messages</button>
                <button onclick="navTo('friends')" id="btn-friends" class="tab-btn">Circle</button>
                <button onclick="navTo('admin')" id="btn-admin" class="tab-btn text-yellow-500 hidden">Staff Room</button>
            </nav>
            <div class="p-6 border-t border-zinc-900">
                <p id="my-name" class="font-bold text-sm text-white"></p>
                <p id="my-credits" class="text-yellow-500 text-[10px]"></p>
            </div>
        </aside>

        <main id="main-body" class="flex flex-col">
            <header class="h-20 flex items-center px-6 border-b border-zinc-900 justify-end">
                <input id="search-bar" oninput="doSearch()" type="text" placeholder="Search ID..." class="bg-zinc-900 p-3 rounded-xl border border-zinc-800 text-xs w-48 focus:w-64 transition-all outline-none">
            </header>
            <div id="main-content" class="content-area"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, updateDoc, deleteDoc, serverTimestamp, orderBy, limit, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDV1Iq9F7N152JjXN7goayLLBiES8B4HkU", authDomain: "trust-games-1.firebaseapp.com", projectId: "trust-games-1", storageBucket: "trust-games-1.firebasestorage.app", messagingSenderId: "923318206410", appId: "1:923318206410:web:646cfe42238f9136cb5933" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myData = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const uID = user.email.split('@')[0].toLowerCase();
                onSnapshot(doc(db, "users", uID), (snap) => {
                    if(!snap.exists()) return;
                    myData = snap.data();
                    document.getElementById('my-name').innerHTML = `${myData.username}${myData.is_verified ? ' âœ…' : ''}`;
                    document.getElementById('my-credits').innerText = `${myData.credits.toLocaleString()} CR`;
                    if(['owner','admin'].includes(myData.role)) document.getElementById('btn-admin').classList.remove('hidden');
                    document.getElementById('app-shell').style.display = 'flex';
                    document.getElementById('loader').style.display = 'none';
                    if(!document.getElementById('main-content').innerHTML) showTab('home');
                });
            } else { location.reload(); }
        });

        window.toggleSidebar = () => document.getElementById('main-sidebar').classList.toggle('active');

        window.navTo = (t) => {
            showTab(t);
            if(window.innerWidth <= 1024) toggleSidebar();
        };

        window.showTab = async (t) => {
            const main = document.getElementById('main-content');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(document.getElementById('btn-'+t)) document.getElementById('btn-'+t).classList.add('active');
            main.innerHTML = `<div class="flex justify-center p-20"><div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full loading-spin"></div></div>`;

            if(t === 'admin') {
                if(!['owner','admin'].includes(myData.role)) { main.innerHTML = "Access Denied"; return; }
                const snap = await getDocs(query(collection(db, "users"), limit(50)));
                main.innerHTML = `<h1 class="text-2xl font-black mb-6">STAFF OVERRIDE</h1><div class="grid gap-2" id="admin-list"></div>`;
                snap.forEach(d => {
                    const u = d.data();
                    document.getElementById('admin-list').innerHTML += `
                        <div onclick="openProfile('${d.id}')" class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 flex justify-between items-center cursor-pointer hover:border-zinc-500">
                            <span class="font-bold text-xs uppercase">${u.username}${u.is_verified ? ' âœ…' : ''}</span>
                            <span class="text-[10px] text-zinc-500">${u.role}</span>
                        </div>`;
                });
            }

            if(t === 'friends') {
                if(!myData.following || myData.following.length === 0) {
                    main.innerHTML = `<div class="text-center p-20 text-zinc-600 text-xs font-bold uppercase tracking-widest">No connections found.</div>`;
                    return;
                }
                main.innerHTML = `<h1 class="text-2xl font-black mb-6">MY CIRCLE</h1><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="f-grid"></div>`;
                for(const fID of myData.following) {
                    const fSnap = await getDoc(doc(db, "users", fID.toLowerCase()));
                    if(fSnap.exists()) {
                        const f = fSnap.data();
                        document.getElementById('f-grid').innerHTML += `
                            <div onclick="openProfile('${fID}')" class="bg-zinc-900 p-6 rounded-[2rem] border border-zinc-800 text-center cursor-pointer hover:bg-zinc-800 transition">
                                <p class="font-black text-[10px] uppercase">${f.username}${f.is_verified ? ' âœ…' : ''}</p>
                            </div>`;
                    }
                }
            }

            if(t === 'home') {
                main.innerHTML = `<div id="s-zone" class="mb-8 hidden"></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="g-grid"></div>`;
                const snap = await getDocs(collection(db, "games"));
                snap.forEach(d => {
                    const g = d.data();
                    document.getElementById('g-grid').innerHTML += `<div onclick="window.open('${g.url}')" class="bg-zinc-900 aspect-square rounded-[2rem] flex flex-col items-center justify-center border border-zinc-800 hover:border-blue-600 cursor-pointer p-4"><div class="text-3xl mb-2">ðŸŽ®</div><p class="text-[10px] font-black uppercase">${g.name}</p></div>`;
                });
            }
        };

        window.openProfile = async (uID) => {
            const s = await getDoc(doc(db, "users", uID.toLowerCase()));
            if(!s.exists()) return;
            const u = s.data();
            const isMeAdmin = ['owner','admin'].includes(myData.role);
            const isF = myData.following?.includes(uID.toLowerCase());

            document.getElementById('modal-inner').innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-4xl font-black text-yellow-500 mb-1">${u.credits.toLocaleString()}</p>
                    <h2 class="text-xl font-bold uppercase text-white">${u.username}${u.is_verified ? ' âœ…' : ''}</h2>
                </div>
                ${isMeAdmin ? `
                <div class="space-y-3 pt-4 border-t border-zinc-800">
                    <input id="ed-c" type="number" value="${u.credits}" class="w-full bg-black border border-zinc-800 p-3 rounded-xl text-xs outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="quickUpdate('${uID}', 'is_verified', ${!u.is_verified})" class="p-3 rounded-xl border border-zinc-800 text-[10px] font-bold uppercase ${u.is_verified ? 'bg-blue-600' : ''}">Verify</button>
                        <button onclick="quickUpdate('${uID}', 'is_banned', ${!u.is_banned})" class="p-3 rounded-xl border border-zinc-800 text-[10px] font-bold uppercase ${u.is_banned ? 'bg-red-600' : ''}">Ban</button>
                    </div>
                    <button onclick="saveAdminCredits('${uID}')" class="w-full bg-white text-black py-3 rounded-xl font-black text-[10px] uppercase">Update Credits</button>
                </div>` : ''}
                <div class="flex gap-2 mt-6">
                    <button onclick="toggleFollow('${uID}', ${isF})" class="flex-1 py-4 rounded-xl font-black uppercase text-[10px] ${isF ? 'bg-zinc-800' : 'bg-blue-600'}">${isF ? 'Unfollow' : 'Follow'}</button>
                </div>
            `;
            document.getElementById('profile-modal').style.display = 'flex';
        };

        window.quickUpdate = async (id, field, val) => {
            await updateDoc(doc(db, "users", id.toLowerCase()), { [field]: val });
            openProfile(id);
        };

        window.saveAdminCredits = async (id) => {
            const amt = parseInt(document.getElementById('ed-c').value);
            await updateDoc(doc(db, "users", id.toLowerCase()), { credits: amt });
            alert("Credits Updated");
            openProfile(id);
        };

        window.toggleFollow = async (id, isF) => {
            await updateDoc(doc(db, "users", myData.username.toLowerCase()), { following: isF ? arrayRemove(id.toLowerCase()) : arrayUnion(id.toLowerCase()) });
            openProfile(id);
        };

        window.doSearch = async () => {
            const v = document.getElementById('search-bar').value.toLowerCase();
            const z = document.getElementById('s-zone'); if(!v) { z.classList.add('hidden'); return; }
            z.classList.remove('hidden'); z.innerHTML = "";
            const snap = await getDocs(query(collection(db, "users"), where("username", ">=", v), where("username", "<=", v + "\uf8ff"), limit(5)));
            snap.forEach(d => { 
                z.innerHTML += `<div onclick="openProfile('${d.id}')" class="bg-zinc-900 p-4 rounded-xl cursor-pointer mb-2 font-black uppercase text-[10px] border border-zinc-800 flex justify-between"><span>${d.data().username}</span></div>`; 
            });
        };
    </script>
</body>
</html>
